<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>昶青實業採購課系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* 儀表板特定樣式 */
.stat-card {
    transition: transform 0.2s, box-shadow 0.2s;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.stat-card .card-body {
    padding: 1.5rem 1rem;
}

.stat-card h3 {
    margin: 0;
    font-weight: 600;
}

.stat-card h6 {
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
    color: #6c757d;
}

/* 圖表容器樣式 */
.card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    font-weight: 600;
}

.card-header h5 {
    margin: 0;
    color: #495057;
}

/* 表格樣式 */
#recentOrdersTable {
    font-size: 0.9rem;
}

#recentOrdersTable th {
    font-weight: 600;
    font-size: 0.85rem;
    white-space: nowrap;
}

#recentOrdersTable td {
    vertical-align: middle;
}

/* 統計摘要樣式 */
#summaryStats h6 {
    color: #495057;
    font-weight: 600;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 0.5rem;
    margin-bottom: 0.75rem;
}

#summaryStats .d-flex {
    padding: 0.25rem 0;
    border-bottom: 1px solid #f1f3f4;
}

#summaryStats .d-flex:last-child {
    border-bottom: none;
}

/* 響應式調整 */
@media (max-width: 768px) {
    .stat-card .card-body {
        padding: 1rem 0.75rem;
    }
    
    .stat-card h3 {
        font-size: 1.5rem;
    }
    
    .stat-card h6 {
        font-size: 0.8rem;
    }
    
    #recentOrdersTable {
        font-size: 0.8rem;
    }
    
    .card-header h5 {
        font-size: 1rem;
    }
}

/* 載入動畫 */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* 徽章樣式 */
.badge {
    font-size: 0.75rem;
}

/* 工具提示 */
[title] {
    cursor: help;
}

        /* ===== CSS 樣式 ===== */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: #f8f9fa;
        }

        /* 登入頁面樣式 */
        .login-page {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: none;
            border-radius: 15px;
            overflow: hidden;
        }

        .login-card .card-header {
            background: var(--primary-color);
            color: white;
            padding: 2rem;
            border-bottom: none;
        }

        .login-card .card-body {
            padding: 2rem;
        }

        /* 主系統樣式 */
        .wrapper {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-color);
            color: white;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            background: rgba(0,0,0,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 0.75rem 1.5rem;
            border-radius: 0;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 2rem;
            transition: all 0.3s;
        }

        .stat-card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .btn-group-actions {
            display: flex;
            gap: 0.5rem;
        }

        .badge {
            font-size: 0.75em;
        }

        .modal-header {
            background: var(--primary-color);
            color: white;
        }

        .form-floating label {
            color: #6c757d;
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .sidebar {
                margin-left: calc(-1 * var(--sidebar-width));
            }
            
            .sidebar.show {
                margin-left: 0;
            }
            
            .content {
                margin-left: 0;
                padding: 1rem;
            }
        }

        /* 隱藏類別 */
        .d-none {
            display: none !important;
        }

        /* 載入動畫 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <!-- ===== 登入頁面 ===== -->
    <div id="loginPage" class="login-page">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-4">
                    <div class="card login-card">
                        <div class="card-header text-center">
                            <h3><i class="fas fa-shopping-cart me-2"></i>昶青實業採購課系統</h3>
                        </div>
                        <div class="card-body">
                            <form id="loginForm">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="userId" placeholder="使用者帳號" required>
                                    <label for="userId">使用者帳號</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="password" class="form-control" id="password" placeholder="密碼" required>
                                    <label for="password">密碼</label>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 py-2">
                                    <i class="fas fa-sign-in-alt me-2"></i>登入
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== 主系統頁面 ===== -->
    <div id="mainSystem" class="d-none">
        <div class="wrapper">
            <!-- 側邊欄 -->
            <nav id="sidebar" class="sidebar">
                <div class="sidebar-header">
                    <h4><i class="fas fa-shopping-cart me-2"></i>採購課系統</h4>
                    <small id="userInfo">使用者：</small>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-page="dashboard">
                            <i class="fas fa-tachometer-alt me-2"></i>儀表板
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="purchase-orders">
                            <i class="fas fa-file-invoice me-2"></i>採購管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="vendors">
                            <i class="fas fa-building me-2"></i>廠商管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="quotations">
                            <i class="fas fa-calculator me-2"></i>報價管理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-page="reports">
                            <i class="fas fa-chart-bar me-2"></i>報表分析
                        </a>
                    </li>
                    <li class="nav-item mt-auto">
                        <a class="nav-link" href="#" id="logoutBtn">
                            <i class="fas fa-sign-out-alt me-2"></i>登出
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- 主要內容區域 -->
            <div id="content" class="content">
                <!-- 儀表板頁面 -->
                <div id="dashboardPage" class="page-content">
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-tachometer-alt me-2"></i>採購管理儀表板</h2>
                <p class="text-muted">基於總表資料的統計分析 | 最後更新：<span id="lastUpdated">-</span></p>
            </div>
        </div>
        
        <!-- 統計卡片 -->
        <div class="row mb-4">
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-shopping-cart fa-2x text-primary mb-2"></i>
                        <h6 class="card-title">總採購案件</h6>
                        <h3 class="text-primary" id="totalOrders">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-calendar-alt fa-2x text-info mb-2"></i>
                        <h6 class="card-title">本月案件</h6>
                        <h3 class="text-info" id="monthlyOrders">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                        <h6 class="card-title">總未稅金額</h6>
                        <h3 class="text-success" id="totalUntaxedAmount">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-receipt fa-2x text-warning mb-2"></i>
                        <h6 class="card-title">總含稅金額</h6>
                        <h3 class="text-warning" id="totalTaxedAmount">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-building fa-2x text-secondary mb-2"></i>
                        <h6 class="card-title">合作廠商</h6>
                        <h3 class="text-secondary" id="vendorCount">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-sitemap fa-2x text-dark mb-2"></i>
                        <h6 class="card-title">採購部門</h6>
                        <h3 class="text-dark" id="departmentCount">-</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 第二排統計卡片 -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                        <h6 class="card-title">本月未稅金額</h6>
                        <h3 class="text-info" id="monthlyUntaxedAmount">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-chart-bar fa-2x text-warning mb-2"></i>
                        <h6 class="card-title">本月含稅金額</h6>
                        <h3 class="text-warning" id="monthlyTaxedAmount">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-calculator fa-2x text-success mb-2"></i>
                        <h6 class="card-title">平均單價</h6>
                        <h3 class="text-success" id="avgUnitPrice">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stat-card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-tags fa-2x text-primary mb-2"></i>
                        <h6 class="card-title">採購類別</h6>
                        <h3 class="text-primary" id="categoryCount">-</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- 圖表區域 -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>部門採購分布</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="departmentChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-donut me-2"></i>採購大項分布</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="categoryChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i>採購細項統計 (前15項)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="subcategoryChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar me-2"></i>主要廠商 (前10名)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="vendorChart" style="max-height: 350px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-8 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line me-2"></i>月度採購趨勢</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="monthlyTrendChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>金額分級</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="amountLevelChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 採購種類分布 -->
        <div class="row mb-4">
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>採購種類分布</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="typeChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-3">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-info-circle me-2"></i>統計摘要</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshDashboard()">
                            <i class="fas fa-refresh me-1"></i>重新整理
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="summaryStats" class="row">
                            <div class="col-12 text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">載入中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最新採購案件 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list me-2"></i>最新採購案件</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="exportRecentOrders()">
                                <i class="fas fa-download me-1"></i>匯出
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadRecentOrdersFromAPI()">
                                <i class="fas fa-refresh me-1"></i>重新整理
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="recentOrdersTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>項次</th>
                                        <th>採購日期</th>
                                        <th>採購編碼</th>
                                        <th>部門</th>
                                        <th>大項</th>
                                        <th>細項</th>
                                        <th>品名</th>
                                        <th>數量</th>
                                        <th>單位</th>
                                        <th>未稅金額</th>
                                        <th>含稅金額</th>
                                        <th>廠商</th>
                                        <th>金額分級</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="13" class="text-center">載入中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


                <!-- 廠商管理頁面 -->
                <div id="vendorsPage" class="page-content d-none">
                    <div class="container-fluid">
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <h2><i class="fas fa-building me-2"></i>廠商管理</h2>
                                <p class="text-muted">管理合格廠商資料</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newVendorModal">
                                    <i class="fas fa-plus me-2"></i>新增廠商
                                </button>
                            </div>
                        </div>

                        <!-- 廠商列表 -->
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="vendorsTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>廠商編號</th>
                                                <th>廠商名稱</th>
                                                <th>統一編號</th>
                                                <th>聯絡人</th>
                                                <th>電話</th>
                                                <th>廠商類別</th>
                                                <th>評等</th>
                                                <th>狀態</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="9" class="text-center">載入中...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 報價管理頁面 -->
                <div id="quotationsPage" class="page-content d-none">
                    <div class="container-fluid">
                        <div class="row mb-4">
                            <div class="col-12">
                                <h2><i class="fas fa-calculator me-2"></i>報價管理</h2>
                                <p class="text-muted">管理廠商報價與比價作業</p>
                            </div>
                        </div>

                        <!-- 報價列表 -->
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="quotationsTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>報價編號</th>
                                                <th>採購編號</th>
                                                <th>廠商名稱</th>
                                                <th>報價金額</th>
                                                <th>交期</th>
                                                <th>報價日期</th>
                                                <th>是否得標</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="8" class="text-center">載入中...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 報表分析頁面 -->
                <div id="reportsPage" class="page-content d-none">
                    <div class="container-fluid">
                        <div class="row mb-4">
                            <div class="col-12">
                                <h2><i class="fas fa-chart-bar me-2"></i>報表分析</h2>
                                <p class="text-muted">採購數據統計與分析</p>
                            </div>
                        </div>

                        <!-- 報表內容 -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>月度採購趨勢</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="monthlyTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h5>部門採購統計</h5>
                                    </div>
                                    <div class="card-body">
                                        <canvas id="departmentChart"></canvas>
                                                        </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== 模態視窗 ===== -->
    
    <!-- 新增採購案模態視窗 -->
    <div class="modal fade" id="newPurchaseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>新增採購案</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newPurchaseForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="requestingDept" required>
                                    <label for="requestingDept">請購單位</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="requestingPerson" required>
                                    <label for="requestingPerson">請購人員</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="category" required>
                                        <option value="">請選擇</option>
                                        <option value="設備">設備</option>
                                        <option value="服務">服務</option>
                                        <option value="工程">工程</option>
                                        <option value="其他">其他</option>
                                    </select>
                                    <label for="category">採購類別</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="number" class="form-control" id="estimatedAmount" required>
                                    <label for="estimatedAmount">預估金額</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="text" class="form-control" id="itemName" required>
                            <label for="itemName">採購項目名稱</label>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea class="form-control" id="specification" style="height: 100px" required></textarea>
                            <label for="specification">規格說明</label>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="number" class="form-control" id="quantity" required>
                            <label for="quantity">數量</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitNewPurchase()">提交</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增廠商模態視窗 -->
    <div class="modal fade" id="newVendorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>新增廠商</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newVendorForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="vendorName" required>
                                    <label for="vendorName">廠商名稱</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="taxId" required>
                                    <label for="taxId">統一編號</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="contact" required>
                                    <label for="contact">聯絡人</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="tel" class="form-control" id="phone" required>
                                    <label for="phone">電話</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-floating mb-3">
                            <input type="email" class="form-control" id="email" required>
                            <label for="email">Email</label>
                        </div>
                        <div class="form-floating mb-3">
                            <textarea class="form-control" id="address" style="height: 80px" required></textarea>
                            <label for="address">地址</label>
                        </div>
                        <div class="form-floating mb-3">
                            <select class="form-select" id="vendorCategory" required>
                                <option value="">請選擇</option>
                                <option value="設備供應商">設備供應商</option>
                                <option value="服務提供商">服務提供商</option>
                                <option value="工程承包商">工程承包商</option>
                                <option value="其他">其他</option>
                            </select>
                            <label for="vendorCategory">廠商類別</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitNewVendor()">新增</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== JavaScript 代碼 =====
        
        // 全域變數
        let currentUser = null;
        let currentPage = 'dashboard';
        let charts = {};
        
        // API 配置
        const API_CONFIG = {
            baseUrl: 'https://script.google.com/macros/s/AKfycbwml_8qU23BNUO4HYx7Cb-4uig8gfnpcTJ_mo-GscEAuB-ip8x5HxQPd8GwgfK3nvz_/exec',
        };

        // ===== API 服務類別 =====
        class PurchaseAPI {
            constructor() {
                this.baseUrl = API_CONFIG.baseUrl;
            }

            async get(action, params = {}) {
                const url = new URL(this.baseUrl);
                url.searchParams.append('action', action);
                
                Object.keys(params).forEach(key => {
                    if (params[key] !== null && params[key] !== undefined) {
                        url.searchParams.append(key, params[key]);
                    }
                });

                try {
                    const response = await fetch(url);
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('API GET Error:', error);
                    this.showError('網路連線錯誤，請稍後再試');
                    throw error;
                }
            }

            async post(action, data) {
                try {
                    const response = await fetch(this.baseUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ action, ...data })
                    });
                    const result = await response.json();
                    return result;
                } catch (error) {
                    console.error('API POST Error:', error);
                    this.showError('網路連線錯誤，請稍後再試');
                    throw error;
                }
            }

            async getUsers() {
                return await this.get('getUsers');
            }

            async addUser(userData) {
                return await this.post('addUser', userData);
            }

            async updateUser(userData) {
                return await this.post('updateUser', userData);
            }

            async deleteUser(account) {
                return await this.post('deleteUser', { account });
            }

            showError(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 3000);
            }

            showSuccess(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 3000);
            }

            async login(userId, password) {
                return await this.post('login', { userId, password });
            }

            async getPurchaseOrders(filters = {}) {
                return await this.get('getPurchaseOrders', filters);
            }

            async createPurchaseOrder(orderData) {
                return await this.post('createPurchaseOrder', orderData);
            }

            async updatePurchaseOrder(orderId, updateData) {
                return await this.post('updatePurchaseOrder', { orderId, ...updateData });
            }

            async getVendors() {
                return await this.get('getVendors');
            }

            async addVendor(vendorData) {
                return await this.post('addVendor', vendorData);
            }

            async getDashboardData() {
                return await this.get('getDashboardData');
            }

            async getQuotations(purchaseId = null) {
                return await this.get('getQuotations', purchaseId ? { purchaseId } : {});
            }

            async addQuotation(quotationData) {
                return await this.post('addQuotation', quotationData);
            }

            async getReports(reportType) {
                return await this.get('getReports', { reportType });
            }
        }

        // 建立 API 實例
        const api = new PurchaseAPI();

        // ===== 主要應用程式類別 =====
        class PurchaseApp {
            constructor() {
                this.init();
            }

            init() {
                this.bindEvents();
                this.checkLoginStatus();
            }

            bindEvents() {
                document.getElementById('loginForm').addEventListener('submit', this.handleLogin.bind(this));
                document.getElementById('logoutBtn').addEventListener('click', this.handleLogout.bind(this));
                
                document.querySelectorAll('.sidebar .nav-link[data-page]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = e.target.closest('[data-page]').dataset.page;
                        this.showPage(page);
                    });
                });

                document.getElementById('statusFilter')?.addEventListener('change', this.applyFilters.bind(this));
                document.getElementById('amountLevelFilter')?.addEventListener('change', this.applyFilters.bind(this));
                document.getElementById('searchInput')?.addEventListener('input', this.debounce(this.applyFilters.bind(this), 500));
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            checkLoginStatus() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    this.showMainSystem();
                } else {
                    this.showLoginPage();
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                
                const userId = document.getElementById('userId').value;
                const password = document.getElementById('password').value;
                const submitBtn = e.target.querySelector('button[type="submit"]');
                
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>登入中...';
                submitBtn.disabled = true;

                try {
                    const result = await api.login(userId, password);
                    
                    if (result.success) {
                        currentUser = result.data;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        this.showMainSystem();
                        api.showSuccess('登入成功！');
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    api.showError(error.message || '登入失敗，請檢查帳號密碼');
                } finally {
                    submitBtn.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>登入';
                    submitBtn.disabled = false;
                }
            }

            handleLogout() {
                localStorage.removeItem('currentUser');
                currentUser = null;
                this.showLoginPage();
                api.showSuccess('已成功登出');
            }

            showLoginPage() {
                document.getElementById('loginPage').classList.remove('d-none');
                document.getElementById('mainSystem').classList.add('d-none');
                document.body.className = 'login-page';
            }

            showMainSystem() {
                document.getElementById('loginPage').classList.add('d-none');
                document.getElementById('mainSystem').classList.remove('d-none');
                document.body.className = '';
                
                if (currentUser) {
                    document.getElementById('userInfo').textContent = `使用者：${currentUser.name} (${currentUser.role})`;
                }
                
                this.showPage('dashboard');
            }

            showPage(pageName) {
                document.querySelectorAll('.page-content').forEach(page => {
                    page.classList.add('d-none');
                });
                
                const targetPage = document.getElementById(pageName + 'Page');
                if (targetPage) {
                    targetPage.classList.remove('d-none');
                    currentPage = pageName;
                    
                    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                        link.classList.remove('active');
                    });
                    document.querySelector(`[data-page="${pageName}"]`)?.classList.add('active');
                    
                    this.loadPageData(pageName);
                }
            }

            async loadPageData(pageName) {
                try {
                    switch (pageName) {
                        case 'dashboard':
                            await this.loadDashboard();
                            break;
                        case 'purchase-orders':
                            await this.loadPurchaseOrders();
                            break;
                        case 'vendors':
                            await this.loadVendors();
                            break;
                        case 'quotations':
                            await this.loadQuotations();
                            break;
                        case 'reports':
                            await this.loadReports();
                            break;
                    }
                } catch (error) {
                    console.error(`載入 ${pageName} 頁面資料失敗:`, error);
                }
            }

            // ===== 儀表板相關方法 =====
            async loadDashboard() {
                try {
                    console.log('載入儀表板資料...');
                    
                    this.showLoadingState();
                    
                    const response = await api.getDashboardData();
                    
                    if (response.success) {
                        const dashboardData = response.data;
                        
                        if (!dashboardData || dashboardData.totalOrders === 0) {
                            this.showEmptyState();
                            return;
                        }
                        
                        this.updateStatCards(dashboardData);
                        this.initAllCharts(dashboardData);
                        this.updateSummaryStats(dashboardData.summary);
                        
                        document.getElementById('lastUpdated').textContent = 
                            new Date(dashboardData.lastUpdated).toLocaleString('zh-TW');
                        
                        await this.loadRecentOrdersFromAPI();
                        
                    } else {
                        throw new Error(response.message);
                    }
                    
                } catch (error) {
                    console.error('載入儀表板資料失敗:', error);
                    api.showError('載入儀表板資料失敗: ' + error.message);
                    this.showErrorState();
                }
            }

            showEmptyState() {
                const emptyHtml = '<span class="text-muted">暫無資料</span>';
                
                document.getElementById('totalOrders').innerHTML = emptyHtml;
                document.getElementById('monthlyOrders').innerHTML = emptyHtml;
                document.getElementById('totalUntaxedAmount').innerHTML = emptyHtml;
                document.getElementById('totalTaxedAmount').innerHTML = emptyHtml;
                document.getElementById('monthlyUntaxedAmount').innerHTML = emptyHtml;
                document.getElementById('monthlyTaxedAmount').innerHTML = emptyHtml;
                document.getElementById('vendorCount').innerHTML = emptyHtml;
                document.getElementById('departmentCount').innerHTML = emptyHtml;
                document.getElementById('avgUnitPrice').innerHTML = emptyHtml;
                document.getElementById('categoryCount').innerHTML = emptyHtml;
                
                this.initEmptyCharts();
                
                document.getElementById('summaryStats').innerHTML = 
                    '<div class="col-12 text-center text-muted">暫無統計資料</div>';
            }

            initEmptyCharts() {
                const emptyData = {
                    labels: [],
                    data: []
                };
                
                this.initDepartmentChart(emptyData);
                this.initCategoryChart(emptyData);
                this.initSubcategoryChart(emptyData);
                this.initVendorChart(emptyData);
                this.initTypeChart(emptyData);
                this.initAmountLevelChart(emptyData);
                this.initMonthlyTrendChart([]);
            }

            async loadRecentOrdersFromAPI() {
                const tbody = document.querySelector('#recentOrdersTable tbody');
                tbody.innerHTML = '<tr><td colspan="13" class="text-center">載入中...</td></tr>';
                
                try {
                    const response = await api.get('getRecentOrders', { limit: 10 });
                    
                    if (response.success) {
                        const orders = response.data;
                        tbody.innerHTML = '';
                        
                        if (orders.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted">暫無資料</td></tr>';
                            return;
                        }
                        
                        orders.forEach(order => {
                            const row = tbody.insertRow();
                            row.innerHTML = `
                                <td>${order.itemNo || '-'}</td>
                                <td>${this.formatDate(order.purchaseDate)}</td>
                                <td>${order.purchaseCode || '-'}</td>
                                <td>${order.department || '-'}</td>
                                <td>${order.category || '-'}</td>
                                <td>${order.subcategory || '-'}</td>
                                <td title="${order.specification || ''}">${this.truncateText(order.itemName, 20)}</td>
                                <td>${order.quantity || '-'}</td>
                                <td>${order.unit || '-'}</td>
                                <td>${this.formatCurrency(order.untaxedAmount)}</td>
                                <td>${this.formatCurrency(order.taxedAmount)}</td>
                                <td>${order.vendor || '-'}</td>
                                <td><span class="badge bg-${this.getAmountLevelColor(order.amountLevel)}">${order.amountLevel || '-'}</span></td>
                            `;
                        });
                    } else {
                        throw new Error(response.message);
                    }
                    
                } catch (error) {
                    console.error('載入最新採購案件失敗:', error);
                    tbody.innerHTML = '<tr><td colspan="13" class="text-center text-danger">載入失敗，請檢查網路連線或聯絡系統管理員</td></tr>';
                }
            }

            showLoadingState() {
                const loadingHtml = '<div class="spinner-border spinner-border-sm me-2"></div>載入中...';
                
                document.getElementById('totalOrders').innerHTML = loadingHtml;
                document.getElementById('monthlyOrders').innerHTML = loadingHtml;
                document.getElementById('totalUntaxedAmount').innerHTML = loadingHtml;
                document.getElementById('totalTaxedAmount').innerHTML = loadingHtml;
                document.getElementById('monthlyUntaxedAmount').innerHTML = loadingHtml;
                document.getElementById('monthlyTaxedAmount').innerHTML = loadingHtml;
                document.getElementById('vendorCount').innerHTML = loadingHtml;
                document.getElementById('departmentCount').innerHTML = loadingHtml;
                document.getElementById('avgUnitPrice').innerHTML = loadingHtml;
                document.getElementById('categoryCount').innerHTML = loadingHtml;
            }

            updateStatCards(dashboardData) {
                document.getElementById('totalOrders').textContent = dashboardData.totalOrders.toLocaleString();
                document.getElementById('monthlyOrders').textContent = dashboardData.monthlyOrders.toLocaleString();
                document.getElementById('vendorCount').textContent = dashboardData.vendorCount.toLocaleString();
                document.getElementById('departmentCount').textContent = dashboardData.departmentCount.toLocaleString();
                document.getElementById('categoryCount').textContent = dashboardData.categoryCount.toLocaleString();
                
                document.getElementById('totalUntaxedAmount').textContent = 
                    new Intl.NumberFormat('zh-TW', { 
                        style: 'currency', 
                        currency: 'TWD',
                        maximumFractionDigits: 0
                    }).format(dashboardData.totalUntaxedAmount);
                    
                document.getElementById('totalTaxedAmount').textContent = 
                    new Intl.NumberFormat('zh-TW', { 
                        style: 'currency', 
                        currency: 'TWD',
                        maximumFractionDigits: 0
                    }).format(dashboardData.totalTaxedAmount);
                    
                document.getElementById('monthlyUntaxedAmount').textContent = 
                    new Intl.NumberFormat('zh-TW', { 
                        style: 'currency', 
                        currency: 'TWD',
                        maximumFractionDigits: 0
                    }).format(dashboardData.monthlyUntaxedAmount);
                    
                document.getElementById('monthlyTaxedAmount').textContent = 
                    new Intl.NumberFormat('zh-TW', { 
                        style: 'currency', 
                        currency: 'TWD',
                        maximumFractionDigits: 0
                    }).format(dashboardData.monthlyTaxedAmount);
                    
                document.getElementById('avgUnitPrice').textContent = 
                    new Intl.NumberFormat('zh-TW', { 
                        style: 'currency', 
                        currency: 'TWD',
                        maximumFractionDigits: 0
                    }).format(dashboardData.avgUnitPrice);
            }

            initAllCharts(dashboardData) {
                this.initDepartmentChart(dashboardData.departmentChart);
                this.initCategoryChart(dashboardData.categoryChart);
                this.initSubcategoryChart(dashboardData.subcategoryChart);
                this.initVendorChart(dashboardData.vendorChart);
                this.initTypeChart(dashboardData.typeChart);
                this.initAmountLevelChart(dashboardData.amountLevelChart);
                this.initMonthlyTrendChart(dashboardData.monthlyTrend);
            }

            initDepartmentChart(departmentData) {
                const ctx = document.getElementById('departmentChart');
                if (ctx) {
                    if (charts.department) charts.department.destroy();
                    
                    charts.department = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: departmentData.labels,
                            datasets: [{
                                data: departmentData.data,
                                backgroundColor: [
                                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                                    '#4BC0C0', '#36A2EB'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { 
                                        padding: 15, 
                                        usePointStyle: true,
                                        font: { size: 12 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed * 100) / total).toFixed(1);
                                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            initCategoryChart(categoryData) {
                const ctx = document.getElementById('categoryChart');
                if (ctx) {
                    if (charts.category) charts.category.destroy();
                    
                    charts.category = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: categoryData.labels,
                            datasets: [{
                                data: categoryData.data,
                                backgroundColor: [
                                    '#28a745', '#dc3545', '#ffc107', '#007bff',
                                    '#6f42c1', '#fd7e14', '#20c997', '#6c757d'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { 
                                        padding: 15, 
                                        usePointStyle: true,
                                        font: { size: 12 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed * 100) / total).toFixed(1);
                                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            initSubcategoryChart(subcategoryData) {
    const ctx = document.getElementById('subcategoryChart');
    if (ctx) {
        if (charts.subcategory) charts.subcategory.destroy();
        
        charts.subcategory = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: subcategoryData.labels,
                datasets: [{
                    label: '採購案件數',
                    data: subcategoryData.data,
                    backgroundColor: '#36A2EB',
                    borderColor: '#1E88E5',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed.y} 件`;
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
}

            initVendorChart(vendorData) {
                const ctx = document.getElementById('vendorChart');
                if (ctx) {
                    if (charts.vendor) charts.vendor.destroy();
                    
                    charts.vendor = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: vendorData.labels,
                            datasets: [{
                                label: '採購案件數',
                                data: vendorData.data,
                                backgroundColor: '#28a745',
                                borderColor: '#20c997',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.label}: ${context.parsed.y} 件`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            }

            initTypeChart(typeData) {
                const ctx = document.getElementById('typeChart');
                if (ctx) {
                    if (charts.type) charts.type.destroy();
                    
                    charts.type = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: typeData.labels,
                            datasets: [{
                                data: typeData.data,
                                backgroundColor: [
                                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                                    '#9966FF', '#FF9F40'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { 
                                        padding: 15, 
                                        usePointStyle: true,
                                        font: { size: 12 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed * 100) / total).toFixed(1);
                                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            initAmountLevelChart(amountLevelData) {
                const ctx = document.getElementById('amountLevelChart');
                if (ctx) {
                    if (charts.amountLevel) charts.amountLevel.destroy();
                    
                    charts.amountLevel = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: amountLevelData.labels,
                            datasets: [{
                                data: amountLevelData.data,
                                backgroundColor: [
                                    '#28a745', '#ffc107', '#fd7e14', '#dc3545'
                                ],
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { 
                                        padding: 15, 
                                        usePointStyle: true,
                                        font: { size: 12 }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((context.parsed * 100) / total).toFixed(1);
                                            return `${context.label}: ${context.parsed} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            initMonthlyTrendChart(monthlyData) {
                const ctx = document.getElementById('monthlyTrendChart');
                if (ctx) {
                    if (charts.monthlyTrend) charts.monthlyTrend.destroy();
                    
                    charts.monthlyTrend = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: monthlyData.map(item => item.month),
                            datasets: [{
                                label: '採購案件數',
                                data: monthlyData.map(item => item.count),
                                borderColor: '#36A2EB',
                                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                                tension: 0.4,
                                fill: true
                            }, {
                                label: '採購金額 (萬元)',
                                data: monthlyData.map(item => Math.round(item.amount / 10000)),
                                borderColor: '#FF6384',
                                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        font: { size: 12 }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    display: true,
                                    title: {
                                        display: true,
                                        text: '月份'
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: '採購案件數'
                                    },
                                    beginAtZero: true
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: '採購金額 (萬元)'
                                    },
                                    beginAtZero: true,
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                }
                            }
                        }
                    });
                }
            }

            updateSummaryStats(summaryData) {
                const summaryContainer = document.getElementById('summaryStats');
                if (!summaryData) {
                    summaryContainer.innerHTML = '<div class="col-12 text-center text-muted">暫無統計資料</div>';
                    return;
                }

                summaryContainer.innerHTML = `
                    <div class="col-12">
                        <h6>採購統計摘要</h6>
                        <div class="d-flex justify-content-between">
                            <span>最大單筆金額：</span>
                            <strong>${this.formatCurrency(summaryData.maxAmount)}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>最小單筆金額：</span>
                            <strong>${this.formatCurrency(summaryData.minAmount)}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>平均採購金額：</span>
                            <strong>${this.formatCurrency(summaryData.avgAmount)}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>最活躍部門：</span>
                            <strong>${summaryData.topDepartment}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>最大供應商：</span>
                            <strong>${summaryData.topVendor}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>資料更新時間：</span>
                            <strong>${this.formatDateTime(summaryData.lastUpdate)}</strong>
                        </div>
                    </div>
                `;
            }

            // ===== 其他頁面載入方法 =====
            async loadPurchaseOrders() {
                try {
                    const response = await api.getPurchaseOrders();
                    if (response.success) {
                        this.renderPurchaseOrdersTable(response.data);
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    console.error('載入採購單失敗:', error);
                    api.showError('載入採購單失敗');
                }
            }

            async loadVendors() {
                try {
                    const response = await api.getVendors();
                    if (response.success) {
                        this.renderVendorsTable(response.data);
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    console.error('載入廠商資料失敗:', error);
                    api.showError('載入廠商資料失敗');
                }
            }

            async loadQuotations() {
                try {
                    const response = await api.getQuotations();
                    if (response.success) {
                        this.renderQuotationsTable(response.data);
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    console.error('載入報價資料失敗:', error);
                    api.showError('載入報價資料失敗');
                }
            }

            async loadReports() {
                try {
                    const response = await api.getReports('monthly');
                    if (response.success) {
                        this.renderReports(response.data);
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    console.error('載入報表失敗:', error);
                    api.showError('載入報表失敗');
                }
            }

            // ===== 表格渲染方法 =====
            renderPurchaseOrdersTable(orders) {
                const tbody = document.querySelector('#purchaseOrdersTable tbody');
                if (!tbody) return;

                tbody.innerHTML = '';
                
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暫無資料</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${order.purchaseId}</td>
                        <td>${this.formatDate(order.requestDate)}</td>
                        <td>${order.requestingDept}</td>
                        <td>${order.itemName}</td>
                        <td>${this.formatCurrency(order.estimatedAmount)}</td>
                        <td><span class="badge bg-${this.getStatusColor(order.status)}">${order.status}</span></td>
                        <td>${order.requestingPerson}</td>
                        <td>
                            <div class="btn-group-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewPurchaseOrder('${order.purchaseId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editPurchaseOrder('${order.purchaseId}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });
            }

            renderVendorsTable(vendors) {
                const tbody = document.querySelector('#vendorsTable tbody');
                if (!tbody) return;

                tbody.innerHTML = '';
                
                if (vendors.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">暫無資料</td></tr>';
                    return;
                }

                vendors.forEach(vendor => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${vendor.vendorId}</td>
                        <td>${vendor.vendorName}</td>
                        <td>${vendor.taxId}</td>
                        <td>${vendor.contact}</td>
                        <td>${vendor.phone}</td>
                        <td>${vendor.category}</td>
                        <td><span class="badge bg-${this.getRatingColor(vendor.rating)}">${vendor.rating}</span></td>
                        <td><span class="badge bg-${vendor.status === '啟用' ? 'success' : 'secondary'}">${vendor.status}</span></td>
                        <td>
                            <div class="btn-group-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewVendor('${vendor.vendorId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editVendor('${vendor.vendorId}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });
            }

            renderQuotationsTable(quotations) {
                const tbody = document.querySelector('#quotationsTable tbody');
                if (!tbody) return;

                tbody.innerHTML = '';
                
                if (quotations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">暫無資料</td></tr>';
                    return;
                }

                quotations.forEach(quotation => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${quotation.quotationId}</td>
                        <td>${quotation.purchaseId}</td>
                        <td>${quotation.vendorName}</td>
                        <td>${this.formatCurrency(quotation.quotedAmount)}</td>
                        <td>${quotation.deliveryDate}</td>
                        <td>${this.formatDate(quotation.quotationDate)}</td>
                        <td><span class="badge bg-${quotation.isWinner ? 'success' : 'secondary'}">${quotation.isWinner ? '得標' : '未得標'}</span></td>
                        <td>
                            <div class="btn-group-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewQuotation('${quotation.quotationId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });
            }

            // ===== 工具方法 =====
            formatCurrency(amount) {
                if (amount == null || amount === '') return '-';
                return new Intl.NumberFormat('zh-TW', {
                    style: 'currency',
                    currency: 'TWD',
                    maximumFractionDigits: 0
                }).format(amount);
            }

            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-TW');
            }

            formatDateTime(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleString('zh-TW');
            }

            truncateText(text, maxLength) {
                if (!text) return '-';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            getStatusColor(status) {
                const colorMap = {
                    '待審核': 'warning',
                    '已核准': 'success',
                    '進行中': 'info',
                    '已完成': 'primary',
                    '已取消': 'danger'
                };
                return colorMap[status] || 'secondary';
            }

            getRatingColor(rating) {
                const colorMap = {
                    'A': 'success',
                    'B': 'info',
                    'C': 'warning',
                    'D': 'danger'
                };
                return colorMap[rating] || 'secondary';
            }

            getAmountLevelColor(level) {
                const colorMap = {
                    '小額': 'success',
                    '中額': 'warning',
                    '大額': 'danger',
                    '巨額': 'dark'
                };
                return colorMap[level] || 'secondary';
            }

            showErrorState() {
                const errorHtml = '<span class="text-danger">載入失敗</span>';
                
                document.getElementById('totalOrders').innerHTML = errorHtml;
                document.getElementById('monthlyOrders').innerHTML = errorHtml;
                document.getElementById('totalUntaxedAmount').innerHTML = errorHtml;
                document.getElementById('totalTaxedAmount').innerHTML = errorHtml;
                document.getElementById('monthlyUntaxedAmount').innerHTML = errorHtml;
                document.getElementById('monthlyTaxedAmount').innerHTML = errorHtml;
                document.getElementById('vendorCount').innerHTML = errorHtml;
                document.getElementById('departmentCount').innerHTML = errorHtml;
                document.getElementById('avgUnitPrice').innerHTML = errorHtml;
                document.getElementById('categoryCount').innerHTML = errorHtml;
                
                document.getElementById('summaryStats').innerHTML = 
                    '<div class="col-12 text-center text-danger">載入統計資料失敗</div>';
            }
        }

        // ===== 全域函數 =====
        function refreshDashboard() {
            if (app) {
                app.loadDashboard();
            }
        }

        function exportRecentOrders() {
            // 匯出最新採購案件功能
            const table = document.getElementById('recentOrdersTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            let csv = '';
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                const rowData = cells.map(cell => `"${cell.textContent.trim()}"`).join(',');
                csv += rowData + '\n';
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `最新採購案件_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function submitNewPurchase() {
            const form = document.getElementById('newPurchaseForm');
            const formData = new FormData(form);
            
            const purchaseData = {
                requestingDept: formData.get('requestingDept'),
                requestingPerson: formData.get('requestingPerson'),
                category: formData.get('category'),
                estimatedAmount: parseFloat(formData.get('estimatedAmount')),
                itemName: formData.get('itemName'),
                specification: formData.get('specification'),
                quantity: parseInt(formData.get('quantity'))
            };

            try {
                const response = await api.createPurchaseOrder(purchaseData);
                if (response.success) {
                    api.showSuccess('採購案建立成功！');
                    bootstrap.Modal.getInstance(document.getElementById('newPurchaseModal')).hide();
                    form.reset();
                    if (currentPage === 'purchase-orders') {
                        app.loadPurchaseOrders();
                    }
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                api.showError('建立採購案失敗：' + error.message);
            }
        }

        async function submitNewVendor() {
            const form = document.getElementById('newVendorForm');
            const formData = new FormData(form);
            
            const vendorData = {
                vendorName: formData.get('vendorName'),
                taxId: formData.get('taxId'),
                contact: formData.get('contact'),
                phone: formData.get('phone'),
                email: formData.get('email'),
                address: formData.get('address'),
                category: formData.get('vendorCategory')
            };

            try {
                const response = await api.addVendor(vendorData);
                if (response.success) {
                    api.showSuccess('廠商新增成功！');
                    bootstrap.Modal.getInstance(document.getElementById('newVendorModal')).hide();
                    form.reset();
                    if (currentPage === 'vendors') {
                        app.loadVendors();
                    }
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                api.showError('新增廠商失敗：' + error.message);
            }
        }

        // 其他操作函數
        function viewPurchaseOrder(orderId) {
            console.log('查看採購單:', orderId);
            // 實作查看採購單詳情
        }

        function editPurchaseOrder(orderId) {
            console.log('編輯採購單:', orderId);
            // 實作編輯採購單
        }

        function viewVendor(vendorId) {
            console.log('查看廠商:', vendorId);
            // 實作查看廠商詳情
        }

        function editVendor(vendorId) {
            console.log('編輯廠商:', vendorId);
            // 實作編輯廠商
        }

        function viewQuotation(quotationId) {
            console.log('查看報價:', quotationId);
            // 實作查看報價詳情
        }

        // ===== 應用程式初始化 =====
        let app;
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM載入完成，初始化應用程式...');
            app = new PurchaseApp();
        });

        // ===== 錯誤處理 =====
        window.addEventListener('error', function(e) {
            console.error('全域錯誤:', e.error);
            if (api) {
                api.showError('系統發生錯誤，請重新整理頁面或聯絡系統管理員');
            }
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('未處理的Promise拒絕:', e.reason);
            if (api) {
                api.showError('系統發生錯誤，請重新整理頁面或聯絡系統管理員');
            }
        });
    </script>
</body>
</html>


                
